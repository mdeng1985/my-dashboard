<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸ªäººé©¾é©¶èˆ± (å¤šå·¥ä½œåŒºç‰ˆ)</title>
    <style>
        /* åŸºç¡€æ ·å¼ */
        body, html { margin: 0; padding: 0; height: 100%; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #f4f7f9; color: #333; }
        .container { display: flex; height: 100vh; }
        .sidebar { width: 280px; background-color: #ffffff; border-right: 1px solid #e0e0e0; padding: 20px; overflow-y: auto; box-shadow: 2px 0 5px rgba(0,0,0,0.05); display: flex; flex-direction: column; }
        .sidebar-header { border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 15px; }
        .sidebar-header h1 { font-size: 24px; margin: 0; color: #1a73e8; }
        .sidebar-content { flex-grow: 1; }
        .link-category { margin-bottom: 25px; }
        .link-category h2 { font-size: 16px; color: #5f6368; margin-bottom: 12px; border-bottom: 1px solid #eee; padding-bottom: 5px; text-transform: uppercase; letter-spacing: 1px; }
        .sidebar ul { list-style: none; padding: 0; margin: 0; }
        .sidebar li { margin-bottom: 8px; display: flex; align-items: center; justify-content: space-between; border-radius: 8px; transition: background-color 0.2s; }
        .sidebar a { text-decoration: none; color: #3c4043; display: block; padding: 8px 12px; border-radius: 8px 0 0 8px; transition: background-color 0.2s ease, color 0.2s ease; font-size: 14px; flex-grow: 1; }
        .sidebar a:hover, .sidebar a.active { background-color: #e8f0fe; color: #1967d2; }
        .sidebar a .external-icon { display: inline-block; margin-left: 4px; font-size: 12px; color: #888; transform: translateY(-1px); }
        .content { flex-grow: 1; display: flex; flex-direction: column; position: relative; }
        iframe { flex-grow: 1; border: none; width: 100%; height: 100%; background-color: #fff; }
        .loading { padding: 20px; color: #999; }

        /* å·¥ä½œåŒºåˆ‡æ¢ */
        .workspace-switcher { margin-top: 10px; }
        .workspace-switcher label { font-size: 12px; color: #5f6368; margin-right: 10px; }
        .workspace-switcher select { padding: 4px 8px; border-radius: 4px; border: 1px solid #ddd; }
        .workspace-controls { display: none; margin-left: 10px; }
        .edit-mode .workspace-controls { display: inline-block; }
        .workspace-controls button { font-size: 12px; padding: 4px 6px; margin-left: 5px; }

        /* ç¼–è¾‘æ¨¡å¼ä¸‹çš„æ ·å¼ */
        .edit-controls { display: none; align-items: center; padding-right: 5px; }
        .edit-mode .edit-controls { display: flex; }
        .control-btn { cursor: pointer; padding: 4px; font-size: 16px; border: none; background: none; opacity: 0.6; }
        .control-btn:hover { opacity: 1; }
        .delete-btn { color: #c5221f; }
        .edit-btn { color: #1a73e8; }
        .drag-handle { cursor: grab; padding: 0 8px; opacity: 0.2; }
        .edit-mode li:hover .drag-handle { opacity: 0.6; }
        .toggle-switch { position: relative; display: inline-block; width: 34px; height: 20px; margin: 0 4px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 20px; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #2196F3; }
        input:checked + .slider:before { transform: translateX(14px); }
        
        /* æ‹–æ‹½æ ·å¼ */
        .dragging { opacity: 0.5; background: #e8f0fe; }
        .drag-over { border-top: 2px dashed #1a73e8; }

        /* æ·»åŠ /ç¼–è¾‘é“¾æ¥è¡¨å• */
        #add-link-form { display: none; background-color: #f9f9f9; padding: 15px; border-radius: 8px; margin-top: 20px; }
        .form-group { margin-bottom: 10px; }
        .form-group label { display: block; margin-bottom: 5px; font-size: 12px; color: #5f6368; }
        .form-group input, .form-group select { width: calc(100% - 18px); padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        #new-category-input { display: none; margin-top: 10px; }
        .form-buttons { display: flex; justify-content: flex-end; gap: 10px; margin-top: 15px; }
        .form-buttons button { padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; }
        .save-btn { background-color: #1a73e8; color: white; }
        .cancel-btn { background-color: #eee; }

        /* åº•éƒ¨æŒ‰é’®åŒº */
        .sidebar-footer { margin-top: auto; padding-top: 15px; border-top: 1px solid #eee;}
        .data-management { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        .data-management button { width: 100%; padding: 8px; background-color: #f0f0f0; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; font-size: 12px; }
        .data-management button:hover { background-color: #e0e0e0; }
        #edit-mode-toggle { width: 100%; padding: 8px; background-color: #e0e0e0; border: none; border-radius: 4px; cursor: pointer; }
        #edit-mode-toggle.active { background-color: #ffc107; }

        /* é¡¹ç›®å¯åŠ¨å™¨æ ·å¼ */
        #project-launcher { display: none; position: absolute; top: 10px; right: 10px; z-index: 100; background: white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); padding: 15px; width: 350px; border: 1px solid #eee; max-height: calc(100vh - 40px); overflow-y: auto; }
        #project-launcher.visible { display: block; }
        #project-launcher h3 { margin-top: 0; font-size: 16px; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 10px; }
        .project-item { margin-bottom: 15px; border: 1px solid #f0f0f0; padding: 10px; border-radius: 6px; }
        .project-item .project-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .project-item .project-header input { font-size: 14px; font-weight: bold; border: none; border-bottom: 1px dashed #ccc; flex-grow: 1; }
        .path-group { display: flex; align-items: center; margin-bottom: 5px; }
        .path-group span { font-size: 12px; color: #666; margin-right: 8px; min-width: 30px; }
        .path-group input { flex-grow: 1; font-size: 12px; padding: 4px 6px; border: 1px solid #ddd; border-radius: 4px; }
        .path-group button { margin-left: 5px; font-size: 12px; padding: 4px 8px; cursor: pointer; }
        #add-project-btn { width: 100%; margin-top: 10px; padding: 8px; background-color: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; }

        #private-mode-toggle { position: absolute; top: 50%; transform: translateY(-50%); left: 0; z-index: 101; background: #fff; border: 1px solid #ccc; border-left: none; writing-mode: vertical-rl; text-orientation: mixed; padding: 8px 4px; border-radius: 0 8px 8px 0; cursor: pointer; font-size: 12px; color: #666; }
    </style>
</head>
<body>

    <div class="container">
        <!-- å·¦ä¾§å¯¼èˆªæ  -->
        <div id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <h1>æˆ‘çš„é©¾é©¶èˆ±</h1>
                <div class="workspace-switcher">
                    <label for="workspace-select">å·¥ä½œåŒº:</label>
                    <select id="workspace-select"></select>
                    <span class="workspace-controls">
                        <button id="add-workspace-btn" title="æ·»åŠ æ–°å·¥ä½œåŒº">+</button>
                        <button id="rename-workspace-btn" title="é‡å‘½åå½“å‰å·¥ä½œåŒº">âœï¸</button>
                        <button id="delete-workspace-btn" title="åˆ é™¤å½“å‰å·¥ä½œåŒº">ğŸ—‘ï¸</button>
                    </span>
                </div>
            </div>
            <div id="link-container" class="sidebar-content">
                <div class="loading">æ­£åœ¨åŠ è½½é“¾æ¥...</div>
            </div>
            <div class="sidebar-footer">
                <form id="add-link-form">
                    <h4>æ·»åŠ æ–°é“¾æ¥</h4>
                    <div class="form-group">
                        <label for="link-name">åç§°</label>
                        <input type="text" id="link-name" required>
                    </div>
                    <div class="form-group">
                        <label for="link-url">URL</label>
                        <input type="url" id="link-url" required>
                    </div>
                    <div class="form-group">
                        <label for="link-category-select">åˆ†ç±»</label>
                        <select id="link-category-select"></select>
                        <input type="text" id="new-category-input" placeholder="è¾“å…¥æ–°åˆ†ç±»åç§°">
                    </div>
                    <div class="form-buttons">
                        <button type="button" id="cancel-add-btn" class="cancel-btn">å–æ¶ˆ</button>
                        <button type="submit" class="save-btn">ä¿å­˜</button>
                    </div>
                </form>
                <div class="data-management">
                    <button id="import-btn">ä»æ–‡ä»¶å¯¼å…¥</button>
                    <button id="export-btn">å¯¼å‡ºåˆ°æ–‡ä»¶</button>
                    <button id="import-text-btn">ä»æ–‡æœ¬å¯¼å…¥</button>
                    <button id="export-text-btn">å¤åˆ¶åˆ°å‰ªè´´æ¿</button>
                    <input type="file" id="import-file" accept=".json" style="display: none;">
                </div>
                <button id="edit-mode-toggle">è¿›å…¥ç¼–è¾‘æ¨¡å¼</button>
            </div>
        </div>

        <!-- å³ä¾§å†…å®¹æ˜¾ç¤ºåŒº -->
        <div class="content">
            <div id="private-mode-toggle">ğŸš€ é¡¹ç›®å¯åŠ¨å™¨</div>
            <div id="project-launcher">
                <h3>ç§æœ‰é¡¹ç›®å¯åŠ¨å™¨</h3>
                <div id="project-list"></div>
                <button id="add-project-btn">+ æ·»åŠ æ–°é¡¹ç›®</button>
            </div>
            <iframe name="content_frame" id="content_frame" src="https://cn.bing.com"></iframe>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // DOM å…ƒç´ è·å–
            const container = document.getElementById('link-container');
            const iframe = document.getElementById('content_frame');
            const sidebar = document.getElementById('sidebar');
            const editModeToggle = document.getElementById('edit-mode-toggle');
            const addLinkForm = document.getElementById('add-link-form');
            const cancelAddBtn = document.getElementById('cancel-add-btn');
            const importBtn = document.getElementById('import-btn');
            const exportBtn = document.getElementById('export-btn');
            const importFile = document.getElementById('import-file');
            const importTextBtn = document.getElementById('import-text-btn');
            const exportTextBtn = document.getElementById('export-text-btn');
            const categorySelect = document.getElementById('link-category-select');
            const newCategoryInput = document.getElementById('new-category-input');
            const projectLauncher = document.getElementById('project-launcher');
            const privateModeToggle = document.getElementById('private-mode-toggle');
            const projectList = document.getElementById('project-list');
            const addProjectBtn = document.getElementById('add-project-btn');
            const workspaceSelect = document.getElementById('workspace-select');
            const addWorkspaceBtn = document.getElementById('add-workspace-btn');
            const renameWorkspaceBtn = document.getElementById('rename-workspace-btn');
            const deleteWorkspaceBtn = document.getElementById('delete-workspace-btn');

            // çŠ¶æ€å˜é‡
            let allData = {};
            let currentActiveLink = null;
            let draggedItem = { fromCatIndex: -1, fromLinkIndex: -1 };

            const defaultData = {
                workspaces: [
                    { 
                        name: "é»˜è®¤å·¥ä½œåŒº",
                        links: [
                            { "category": "çµæ„Ÿä¸æ´å¯Ÿ", "links": [ { "name": "Product Hunt", "url": "https://www.producthunt.com/", "external": true }, { "name": "Hacker News", "url": "https://news.ycombinator.com/show" } ] }
                        ]
                    }
                ],
                projects: [
                    { name: "æˆ‘çš„ç¬¬ä¸€ä¸ªå·¥å…·", docPath: "C:\\Users\\YourName\\Documents\\Tool1", codePath: "D:\\Projects\\Tool1" }
                ],
                currentWorkspaceIndex: 0
            };

            // --- æ•°æ®å¤„ç† ---
            function loadData() {
                const storedData = localStorage.getItem('dashboardConfig');
                allData = storedData ? JSON.parse(storedData) : defaultData;
                if (!allData.workspaces || allData.workspaces.length === 0) {
                    allData.workspaces = defaultData.workspaces;
                    allData.currentWorkspaceIndex = 0;
                }
                if (allData.currentWorkspaceIndex >= allData.workspaces.length) {
                    allData.currentWorkspaceIndex = 0;
                }
                
                const launcherVisible = localStorage.getItem('dashboardLauncherVisible') === 'true';
                if (launcherVisible) projectLauncher.classList.add('visible');

                render();
            }

            function saveData() {
                localStorage.setItem('dashboardConfig', JSON.stringify(allData));
                render();
            }
            
            function exportData() {
                return JSON.stringify(allData, null, 2);
            }

            function importData(dataStr) {
                try {
                    const importedData = JSON.parse(dataStr);
                    if (importedData && typeof importedData === 'object' && importedData.workspaces) {
                        allData = importedData;
                        saveData();
                        alert('é…ç½®å¯¼å…¥æˆåŠŸï¼');
                    } else {
                        throw new Error('JSONæ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®ã€‚');
                    }
                } catch (error) {
                    alert(`å¯¼å…¥å¤±è´¥: ${error.message}`);
                }
            }

            // --- æ¸²æŸ“ ---
            function render() {
                renderWorkspaceSwitcher();
                renderCurrentWorkspaceLinks();
                renderProjects();
            }

            function renderWorkspaceSwitcher() {
                workspaceSelect.innerHTML = '';
                allData.workspaces.forEach((ws, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = ws.name;
                    if (index === allData.currentWorkspaceIndex) {
                        option.selected = true;
                    }
                    workspaceSelect.appendChild(option);
                });
            }

            function renderCurrentWorkspaceLinks() {
                const currentWorkspace = allData.workspaces[allData.currentWorkspaceIndex];
                if (!currentWorkspace) return;

                container.innerHTML = '';
                (currentWorkspace.links || []).forEach((cat, catIndex) => {
                    const categoryDiv = document.createElement('div');
                    categoryDiv.className = 'link-category';
                    const categoryTitle = document.createElement('h2');
                    categoryTitle.textContent = cat.category;
                    categoryDiv.appendChild(categoryTitle);
                    const linkList = document.createElement('ul');
                    cat.links.forEach((link, linkIndex) => {
                        const listItem = document.createElement('li');
                        listItem.dataset.catIndex = catIndex;
                        listItem.dataset.linkIndex = linkIndex;
                        listItem.draggable = true;
                        listItem.addEventListener('dragstart', handleDragStart);
                        listItem.addEventListener('dragover', handleDragOver);
                        listItem.addEventListener('dragleave', handleDragLeave);
                        listItem.addEventListener('drop', handleDrop);
                        listItem.addEventListener('dragend', handleDragEnd);
                        const linkAnchor = document.createElement('a');
                        linkAnchor.href = link.url;
                        linkAnchor.innerHTML = link.external ? `${link.name} <span class="external-icon">â†—</span>` : link.name;
                        linkAnchor.addEventListener('click', (e) => handleLinkClick(e, link, linkAnchor));
                        const dragHandle = document.createElement('span');
                        dragHandle.className = 'drag-handle';
                        dragHandle.innerHTML = '&#9776;';
                        listItem.appendChild(dragHandle);
                        listItem.appendChild(linkAnchor);
                        const editControls = createEditControls(link, catIndex, linkIndex);
                        listItem.appendChild(editControls);
                        linkList.appendChild(listItem);
                    });
                    categoryDiv.appendChild(linkList);
                    container.appendChild(categoryDiv);
                });
                updateCategoryDropdown();
            }

            function renderProjects() {
                projectList.innerHTML = '';
                (allData.projects || []).forEach((proj, index) => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'project-item';
                    
                    itemDiv.innerHTML = `
                        <div class="project-header">
                            <input type="text" class="project-name-input" value="${proj.name}" data-index="${index}" placeholder="é¡¹ç›®åç§°">
                            <button class="control-btn delete-btn delete-project-btn" data-index="${index}" title="åˆ é™¤é¡¹ç›®">Ã—</button>
                        </div>
                        <div class="path-group">
                            <span>æ–‡æ¡£</span>
                            <input type="text" class="project-doc-path" value="${proj.docPath}" data-index="${index}" placeholder="æ–‡æ¡£æ–‡ä»¶å¤¹è·¯å¾„">
                            <button class="copy-btn" data-target="doc" data-index="${index}">å¤åˆ¶</button>
                        </div>
                        <div class="path-group">
                            <span>ä»£ç </span>
                            <input type="text" class="project-code-path" value="${proj.codePath}" data-index="${index}" placeholder="ä»£ç æ–‡ä»¶å¤¹è·¯å¾„">
                            <button class="copy-btn" data-target="code" data-index="${index}">å¤åˆ¶</button>
                        </div>
                    `;
                    projectList.appendChild(itemDiv);
                });

                projectList.querySelectorAll('.project-name-input, .project-doc-path, .project-code-path').forEach(input => {
                    input.addEventListener('change', updateProjectData);
                });
                projectList.querySelectorAll('.delete-project-btn').forEach(btn => btn.addEventListener('click', deleteProject));
                projectList.querySelectorAll('.copy-btn').forEach(btn => btn.addEventListener('click', copyPath));
            }

            function createEditControls(link, catIndex, linkIndex) {
                const editControls = document.createElement('div');
                editControls.className = 'edit-controls';
                const editBtn = document.createElement('button');
                editBtn.innerHTML = 'âœï¸';
                editBtn.className = 'control-btn edit-btn';
                editBtn.title = 'ç¼–è¾‘é“¾æ¥';
                editBtn.addEventListener('click', () => handleEditLink(link, catIndex, linkIndex));
                const toggleLabel = document.createElement('label');
                toggleLabel.className = 'toggle-switch';
                const toggleInput = document.createElement('input');
                toggleInput.type = 'checkbox';
                toggleInput.checked = link.external || false;
                toggleInput.addEventListener('change', () => {
                    link.external = toggleInput.checked;
                    saveData();
                });
                const slider = document.createElement('span');
                slider.className = 'slider';
                toggleLabel.append(toggleInput, slider);
                const deleteBtn = document.createElement('button');
                deleteBtn.innerHTML = 'Ã—';
                deleteBtn.className = 'control-btn delete-btn';
                deleteBtn.title = 'åˆ é™¤é“¾æ¥';
                deleteBtn.addEventListener('click', () => {
                    if (confirm(`ç¡®å®šè¦åˆ é™¤ "${link.name}" å—ï¼Ÿ`)) {
                        allData.workspaces[allData.currentWorkspaceIndex].links[catIndex].links.splice(linkIndex, 1);
                        if (allData.workspaces[allData.currentWorkspaceIndex].links[catIndex].links.length === 0) {
                            allData.workspaces[allData.currentWorkspaceIndex].links.splice(catIndex, 1);
                        }
                        saveData();
                    }
                });
                editControls.append(editBtn, toggleLabel, deleteBtn);
                return editControls;
            }

            function updateCategoryDropdown() {
                const currentWorkspace = allData.workspaces[allData.currentWorkspaceIndex];
                categorySelect.innerHTML = '';
                if (!currentWorkspace) return;

                const links = currentWorkspace.links || [];

                links.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.category;
                    option.textContent = cat.category;
                    categorySelect.appendChild(option);
                });
                const newOption = document.createElement('option');
                newOption.value = '__addNew__';
                newOption.textContent = '-- æ·»åŠ æ–°åˆ†ç±» --';
                categorySelect.appendChild(newOption);

                // Fix: Manually trigger visibility check after rendering the dropdown
                newCategoryInput.style.display = categorySelect.value === '__addNew__' ? 'block' : 'none';
            }
            
            // --- äº‹ä»¶å¤„ç† ---
            function handleLinkClick(event, link, element) {
                event.preventDefault();
                if (sidebar.classList.contains('edit-mode')) return;
                if (currentActiveLink) currentActiveLink.classList.remove('active');
                if (link.external) {
                    window.open(link.url, '_blank', 'noopener,noreferrer');
                    iframe.src = `data:text/html,<body style="font-family: sans-serif; display: flex; justify-content: center; align-items: center; height: 90vh; color: #888; text-align: center;"><h1>'${link.name}'<br/>å·²åœ¨æ–°æ ‡ç­¾é¡µä¸­æ‰“å¼€</h1></body>`;
                } else {
                    iframe.src = link.url;
                    element.classList.add('active');
                    currentActiveLink = element;
                }
            }
            
            function handleEditLink(link, catIndex, linkIndex) {
                const newName = prompt("è¾“å…¥æ–°çš„é“¾æ¥åç§°:", link.name);
                if (newName === null || newName.trim() === '') return;
                const newUrl = prompt("è¾“å…¥æ–°çš„é“¾æ¥ URL:", link.url);
                if (newUrl === null || newUrl.trim() === '') return;
                allData.workspaces[allData.currentWorkspaceIndex].links[catIndex].links[linkIndex].name = newName.trim();
                allData.workspaces[allData.currentWorkspaceIndex].links[catIndex].links[linkIndex].url = newUrl.trim();
                saveData();
            }

            function handleDragStart(e) { this.classList.add('dragging'); draggedItem.fromCatIndex = parseInt(this.dataset.catIndex); draggedItem.fromLinkIndex = parseInt(this.dataset.linkIndex); }
            function handleDragOver(e) { e.preventDefault(); this.classList.add('drag-over'); }
            function handleDragLeave(e) { this.classList.remove('drag-over'); }
            function handleDrop(e) {
                e.preventDefault();
                this.classList.remove('drag-over');
                const toCatIndex = parseInt(this.dataset.catIndex);
                const toLinkIndex = parseInt(this.dataset.linkIndex);
                const links = allData.workspaces[allData.currentWorkspaceIndex].links;
                const itemToMove = links[draggedItem.fromCatIndex].links.splice(draggedItem.fromLinkIndex, 1)[0];
                links[toCatIndex].links.splice(toLinkIndex, 0, itemToMove);
                if (links[draggedItem.fromCatIndex].links.length === 0) {
                    links.splice(draggedItem.fromCatIndex, 1);
                }
                saveData();
            }
            function handleDragEnd(e) { this.classList.remove('dragging'); document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over')); }

            // å·¥ä½œåŒºäº‹ä»¶
            workspaceSelect.addEventListener('change', (e) => {
                allData.currentWorkspaceIndex = parseInt(e.target.value);
                saveData();
            });

            addWorkspaceBtn.addEventListener('click', () => {
                const name = prompt("è¾“å…¥æ–°å·¥ä½œåŒºçš„åç§°:");
                if (name && name.trim()) {
                    allData.workspaces.push({ name: name.trim(), links: [] });
                    allData.currentWorkspaceIndex = allData.workspaces.length - 1;
                    saveData();
                }
            });

            renameWorkspaceBtn.addEventListener('click', () => {
                const currentWorkspace = allData.workspaces[allData.currentWorkspaceIndex];
                const newName = prompt("è¾“å…¥æ–°çš„åç§°:", currentWorkspace.name);
                if (newName && newName.trim()) {
                    currentWorkspace.name = newName.trim();
                    saveData();
                }
            });

            deleteWorkspaceBtn.addEventListener('click', () => {
                if (allData.workspaces.length <= 1) {
                    alert("ä¸èƒ½åˆ é™¤æœ€åä¸€ä¸ªå·¥ä½œåŒºï¼");
                    return;
                }
                const currentWorkspace = allData.workspaces[allData.currentWorkspaceIndex];
                if (confirm(`ç¡®å®šè¦åˆ é™¤å·¥ä½œåŒº "${currentWorkspace.name}" å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼`)) {
                    allData.workspaces.splice(allData.currentWorkspaceIndex, 1);
                    allData.currentWorkspaceIndex = 0;
                    saveData();
                }
            });

            // é¡¹ç›®å¯åŠ¨å™¨äº‹ä»¶
            privateModeToggle.addEventListener('click', () => {
                projectLauncher.classList.toggle('visible');
                localStorage.setItem('dashboardLauncherVisible', projectLauncher.classList.contains('visible'));
            });

            addProjectBtn.addEventListener('click', () => {
                if (!allData.projects) allData.projects = [];
                allData.projects.push({ name: "æ–°é¡¹ç›®", docPath: "", codePath: "" });
                saveData();
            });
            
            function updateProjectData(e) {
                const index = e.target.dataset.index;
                if (e.target.classList.contains('project-name-input')) {
                    allData.projects[index].name = e.target.value;
                } else if (e.target.classList.contains('project-doc-path')) {
                    allData.projects[index].docPath = e.target.value;
                } else if (e.target.classList.contains('project-code-path')) {
                    allData.projects[index].codePath = e.target.value;
                }
                saveData();
            }

            function deleteProject(e) {
                const index = e.target.dataset.index;
                if (confirm(`ç¡®å®šè¦åˆ é™¤é¡¹ç›® "${allData.projects[index].name}" å—ï¼Ÿ`)) {
                    allData.projects.splice(index, 1);
                    saveData();
                }
            }

            function copyPath(e) {
                const index = e.target.dataset.index;
                const target = e.target.dataset.target;
                const path = (target === 'doc') ? allData.projects[index].docPath : allData.projects[index].codePath;
                if (!path) { alert("è·¯å¾„ä¸ºç©ºï¼Œæ— æ³•å¤åˆ¶ï¼"); return; }
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(path).then(() => alert('è·¯å¾„å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼')).catch(err => alert('å¤åˆ¶å¤±è´¥!'));
                } else {
                    const textArea = document.createElement("textarea");
                    textArea.value = path;
                    document.body.appendChild(textArea);
                    textArea.select();
                    try { document.execCommand('copy'); alert('è·¯å¾„å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼'); } catch (err) { alert('å¤åˆ¶å¤±è´¥!'); }
                    document.body.removeChild(textArea);
                }
            }

            // è¡¨å•å’ŒæŒ‰é’®äº‹ä»¶
            editModeToggle.addEventListener('click', () => {
                sidebar.classList.toggle('edit-mode');
                const isActive = sidebar.classList.contains('edit-mode');
                editModeToggle.textContent = isActive ? 'å®Œæˆç¼–è¾‘' : 'è¿›å…¥ç¼–è¾‘æ¨¡å¼';
                editModeToggle.classList.toggle('active', isActive);
                addLinkForm.style.display = isActive ? 'block' : 'none';
                if (!isActive) { addLinkForm.reset(); newCategoryInput.style.display = 'none'; }
            });

            categorySelect.addEventListener('change', () => {
                newCategoryInput.style.display = categorySelect.value === '__addNew__' ? 'block' : 'none';
            });

            addLinkForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const name = document.getElementById('link-name').value.trim();
                const url = document.getElementById('link-url').value.trim();
                let category = categorySelect.value;
                if (category === '__addNew__') {
                    category = newCategoryInput.value.trim();
                    if (category === '') { alert("æ–°åˆ†ç±»åç§°ä¸èƒ½ä¸ºç©ºï¼"); return; }
                }
                if (!name || !url || !category) { alert("è¯·å¡«å†™æ‰€æœ‰å­—æ®µï¼"); return; }
                
                const currentWorkspace = allData.workspaces[allData.currentWorkspaceIndex];
                let categoryExists = currentWorkspace.links.find(c => c.category === category);
                if (categoryExists) {
                    categoryExists.links.push({ name, url, external: false });
                } else {
                    currentWorkspace.links.push({ category, links: [{ name, url, external: false }] });
                }
                saveData();
                addLinkForm.reset();
                newCategoryInput.style.display = 'none';
            });

            cancelAddBtn.addEventListener('click', () => { addLinkForm.reset(); newCategoryInput.style.display = 'none'; });
            
            exportBtn.addEventListener('click', () => {
                const dataStr = exportData();
                const blob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'dashboard-config.json';
                a.click();
                URL.revokeObjectURL(url);
            });
            exportTextBtn.addEventListener('click', () => {
                const dataStr = exportData();
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(dataStr).then(() => alert('é…ç½®å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼'));
                } else {
                    const textArea = document.createElement("textarea");
                    textArea.value = dataStr;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    alert('é…ç½®å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
                }
            });
            
            importBtn.addEventListener('click', () => importFile.click());
            importFile.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => importData(e.target.result);
                reader.readAsText(file);
                importFile.value = '';
            });

            importTextBtn.addEventListener('click', () => {
                const textData = prompt("è¯·åœ¨æ­¤å¤„ç²˜è´´æ‚¨çš„é…ç½®æ–‡æœ¬:");
                if (textData) {
                    importData(textData);
                }
            });

            // --- åˆå§‹åŒ– ---
            loadData();
        });
    </script>

</body>
</html>
